# 01 Getting started

扩展程序（插件）由不同的组件组合而成，但他们之间互相有关联。组件可以由以下几块内容组成：

- background scripts 后台脚本
- content scripts 内容脚本
- options page 配置页面
- UI elements(User interface) 视图元素
- various logic files 各类逻辑文件

对于每个扩展组件来说，这些不是全部需要。依据具体功能需求来决定如何搭配、选用上述内容。

扩展使用 web 技术栈：HTML、CSS 和 JS 进行开发。

本教程将会构建一个可以让用户修改当前活动页面的 `background color 背景色`。这会用到很多扩展组件，给到一个介绍它们关联性的演示。

首先，需要创建一个新的目录用于存放 `插件` 的相关文件。

## 创建 manifest 文件

`manifest.json` 是整个插件的启动文件，代码示例如下

```json
{
  "name": "Getting Started Example",
  "description": "Build an Extension!",
  "version": "1.0",
  "manifest_version": 3
}
```

### 加载已解压的插件

包含 `manifest.json` 文件的目录，可以在浏览器 `开发模式` 下被作为插件进行加载。步骤如下：

1. 打开浏览器插件管理页面 `chroem://extensions`。还有两种方式可以进入该页面。
   1. 或者，![插件管理图标](https://cdn.jsdelivr.net/gh/JunyWuuuu91/JunyWuuuu91.github.io@master/images/20220308022844.png)
   2. 或者，浏览器右上角菜单 -> 更多工具 -> 扩展程序
2. 开启开发者模式，![](https://cdn.jsdelivr.net/gh/JunyWuuuu91/JunyWuuuu91.github.io@master/images/20220308023704.png)
3. 点击 `加载已解压的拓展程序` ![](https://cdn.jsdelivr.net/gh/JunyWuuuu91/JunyWuuuu91.github.io@master/images/20220308023830.png)

完成以上步骤，插件会被成功加载。因为没有设置`icon 图标`，所以目前插件是显示了一个通用默认图标（generic icon）。

## 添加功能

目前因为没有任何逻辑，所以该插件只是被安装了而已。我们现在增加一些代码来实现对 `background-color` 的保存。

### 在 manifest 中注册后台脚本

`background scripts 后台脚本` 跟其他重要的模块一样，需要被注册在 `manifest.json` 的 `background` 字段下。它告诉插件哪一个相关文件需要被引用，以及该文件会如何表现。

```diff
# manifest.json
{
  "name": "Getting Started Example",
  "description": "Build an Extension!",
  "version": "1.0",
  "manifest_version": 3,
+  "background": {
+    "service_worker": "background.js"
+  }
}
```

此时插件意识到有 `service-worker`，便会去扫描指定文件，并去监听其中的一些事件。

### 创建后台脚本

插件安装后立即会从一些 `persistent variable 预设变量` 中获取信息。

- 首先，包括后台脚本 `chrome.runtime.onInstalled` 中的监听事件。在该监听事件中，插件会通过 `storage API` 进行设值。
- 之后，其他的组件就可以对该值进行访问和更新。

创建后台脚本的文件 `background.js`

```js
// background.js
let color = "#3aa757";

chrome.runtime.onInstalled.addListener(() => {
  chrome.storage.sync.set({ color });
  console.log("Default background color set to %cgreen", `color: ${color}`);
});
```

### 增加 storage 的权限

包括 [storage](https://developer.chrome.com/docs/extensions/reference/storage/) 的大部分 API，都需要注册相应的权限。

```diff
# manifest.json
{
  "name": "Getting Started Example",
  "description": "Build an Extension!",
  "version": "1.0",
  "manifest_version": 3,
  "background": {
    "service_worker": "background.js"
  },
+ "permissions": ["storage"]
}
```

### 检查后台脚本的效果

打开`拓展管理页面`，然后到点击 `reload` 按钮。![](https://cdn.jsdelivr.net/gh/JunyWuuuu91/JunyWuuuu91.github.io@master/images/20220308030452.png)

之后会出现 `蓝色字体` 的 `Service Worker` 可点链接。
点击它后会弹出插件的控制台，会看到我们在上面打印的内容。
![](https://cdn.jsdelivr.net/gh/JunyWuuuu91/JunyWuuuu91.github.io@master/images/20220308030618.png)

## 用户界面 User interface

插件可以实现各类用户界面，它是一个悬浮窗体（popup）。

在项目中创建 `popup.html`，我们来完成通过点击一个按钮实现背景色的改变功能。

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./styles/button.css" />
    <title>wjy user interface</title>
  </head>
  <body>
    <button id="changeColor">修改</button>
  </body>
</html>
```

跟后台脚本一样，用户界面也需要在 `manifest.json` 中进行注册和定义后才可以被展示出来。

```diff
# manifest.json
{
  "name": "Getting Started Example",
  "description": "Build an Extension!",
  "version": "1.0",
  "manifest_version": 3,
  "background": {
    "service_worker": "background.js"
  },
  "permissions": ["storage"],
+  "action": {
+    "default_popup": "popup.html"
+  }
}
```

### 增加按钮的样式

补充按钮的样式文件内容 `styles/button.css`

```css
button {
  height: 30px;
  width: 50px;
  outline: none;
  margin: 10px;
  border: none;
  border-radius: 2px;
}

button.current {
  box-shadow: 0 0 0 2px white, 0 0 0 4px black;
}
```

### 增加插件的图标

同样在 `action` 字段下，增加 `default_icon` 对象，来配置各个尺寸对应的图标。

```diff
{
  "name": "Getting Started Example",
  "description": "Build an Extension!",
  "version": "1.0",
  "manifest_version": 3,
  "background": {
    "service_worker": "background.js"
  },
  "permissions": ["storage"],
  "action": {
    "default_popup": "popup.html",
+    "default_icon": {
+      "16": "/images/get_started16.png",
+      "32": "/images/get_started32.png",
+      "48": "/images/get_started48.png",
+      "128": "/images/get_started128.png"
+    }
  }
}
```

上面设置的是在浏览器下看到的插件图标，而在 `插件管理页面` 中也可以配置图标，不然默认是通用图标。使用 `icons` 去配置。
![](https://cdn.jsdelivr.net/gh/JunyWuuuu91/JunyWuuuu91.github.io@master/images/20220308032256.png)

```diff
{
  "name": "Getting Started Example",
  "description": "Build an Extension!",
  "version": "1.0",
  "manifest_version": 3,
  "background": {
    "service_worker": "background.js"
  },
  "permissions": ["storage"],
  "action": {
    "default_popup": "popup.html",
    "default_icon": {
      "16": "/images/get_started16.png",
      "32": "/images/get_started32.png",
      "48": "/images/get_started48.png",
      "128": "/images/get_started128.png"
    }
  },
+  "icons": {
+    "16": "/images/get_started16.png",
+    "32": "/images/get_started32.png",
+    "48": "/images/get_started48.png",
+    "128": "/images/get_started128.png"
+  }
}
```

此时去点击图标，就会弹窗一个窗口，里面包含了一个按钮。
![](https://cdn.jsdelivr.net/gh/JunyWuuuu91/JunyWuuuu91.github.io@master/images/20220308032737.png)

> 目前 chrome 插件安装后会自动隐藏，需要点击 `拼图图标` 然后点选该插件前面的 `图钉`，这样才能直接显示在浏览器插件栏中。
> ![](https://cdn.jsdelivr.net/gh/JunyWuuuu91/JunyWuuuu91.github.io@master/images/20220308032715.png)

### 增加按钮逻辑

创建 `popup.js` 然后在 `popup.html` 中引入，实现通过 `chrome.storage` API 拿到原先存储的 `color` 变量后，再去用该颜色改变按钮背景色。`

```js
// popup.js
let changeColor = document.getElementById("changeColor");

chrome.storage.sync.get("color", ({ color }) => {
  changeColor.style.backgroundColor = color;
});
```

html 中引入 js

```diff
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./styles/button.css" />
    <title>wjy user interface</title>
  </head>
  <body>
    <button id="changeColor">修改</button>
+    <script src="popup.js"></script>
  </body>
</html>

```

## 逻辑层 Layer logic

目前，插件有了自己的图标和用户界面（弹出层）。到此完成上述功能
![](https://cdn.jsdelivr.net/gh/JunyWuuuu91/JunyWuuuu91.github.io@master/images/20220308033223.png)

接下来需要实现更多的用户交互（user interaction），去补充 `popup.js` 的代码。

```js
// When the button is clicked, inject setPageBackgroundColor into current page
changeColor.addEventListener("click", async () => {
  let [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

  chrome.scripting.executeScript({
    target: { tabId: tab.id },
    function: setPageBackgroundColor,
  });
});

// The body of this function will be executed as a content script inside the
// current page
function setPageBackgroundColor() {
  chrome.storage.sync.get("color", ({ color }) => {
    document.body.style.backgroundColor = color;
  });
}
```

这里用到的几个 API 同样需要去 `manifest.json` 中注册。
```diff
{
  "name": "Getting Started Example",
  ...
+  "permissions": ["storage", "activeTab", "scripting"],
  ...
}
```